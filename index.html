<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus+ | Reducci√≥n de Distracciones Digitales</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Tipograf√≠a Poppins (basada en el prototipo adjunto) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Carga de Font Awesome para iconos de apps -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Configuraci√≥n de color principal (Azul corporativo) y fuente Poppins -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // --- PALETA DE COLORES ACTUALIZADA (M√°s Amigable) ---
                        'focus-primary': '#14B8A6', // Teal-500 (Amigable, moderno)
                        'focus-secondary': '#F472B6', // Pink-400 (Vibrante, para contraste)
                        'distraction': '#F43F5E', // Rose-500 (Para alertas y distracciones)
                        'app-bg': '#F9FAFB', // Gray-50 (Fondo ligero)
                    },
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos base de la aplicaci√≥n */
        body {
            background-color: #F9FAFB; /* Fondo de la aplicaci√≥n */
            font-family: 'Poppins', sans-serif;
            overflow: hidden; /* Evitar scroll en el body */
        }

        /* Contenedor principal para simular la vista m√≥vil */
        #app {
            max-width: 420px; /* Ancho m√°ximo de un m√≥vil grande */
            height: 100vh;
            margin: 0 auto;
            position: relative;
            background-color: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.5s ease;
        }

        /* Estilo para el modo enfoque activo (cambia el fondo) */
        #app.focus-active {
            background-color: #E0F2F1; /* Fondo m√°s tranquilo en modo enfoque */
        }

        /* Contenedor de las vistas */
        #view-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Estilo para el Loader (Spinning) */
        .loader {
            border-top-color: #F472B6; /* Color secundario para el giro */
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }

        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Estilos del Toggle Switch para Detecci√≥n de Apps */
        /* CORRECCI√ìN #1: Estilos del Toggle Switch para Detecci√≥n de Apps (Mejor Visualizaci√≥n) */
        .toggle-checkbox {
            display: none;
        }

        .toggle-label {
            display: flex;
            align-items: center; 
            width: 48px; 
            height: 24px; 
            background-color: #E5E7EB; /* gray-200 (Off state) */
            border-radius: 9999px;
            cursor: pointer;
            transition: background-color 0.2s;
            padding: 2px;
            box-sizing: border-box;
        }

        .toggle-label:before {
            content: "";
            display: block;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
            transition: transform 0.2s ease-in-out;
        }

        .toggle-checkbox:checked + .toggle-label {
            background-color: #14B8A6; /* focus-primary (On state) */
        }

        .toggle-checkbox:checked + .toggle-label:before {
            transform: translateX(24px);
        }
        /* Estilo para los botones de filtro de distracciones */
        .distraction-tab {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem; /* sm */
            font-weight: 600;
            transition: all 0.2s;
        }

        .distraction-tab-active {
            background-color: #F472B6; /* focus-secondary */
            color: white;
            box-shadow: 0 4px 6px rgba(244, 114, 182, 0.4);
        }

        .distraction-tab-inactive {
            background-color: #F3F4F6; /* gray-100 */
            color: #6B7280; /* gray-500 */
            border: 1px solid #E5E7EB; /* gray-200 */
        }
    </style>
</head>
<body>

    <!-- Contenedor Principal de la App M√≥vil -->
    <div id="app" class="pb-20">
        
        <!-- Header Fijo (Visible solo despu√©s del login) -->
        <header id="main-header" class="hidden p-4 border-b border-gray-100 bg-white sticky top-0 z-10 shadow-sm">
            <div class="flex justify-between items-center">
                <!-- Logo -->
                <h1 class="text-2xl font-extrabold text-focus-primary">Focus<span class="text-focus-secondary">+</span></h1>
                
                <!-- Balance de Monedas y Nombre del Usuario -->
                <div class="flex items-center space-x-3">
                    <div class="flex items-center text-focus-secondary font-bold text-lg">
                        <span id="coin-balance">1,250</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-1"><circle cx="12" cy="12" r="10"/><path d="M16 8v8M8 8v8M12 16v-4M12 8v-4M12 12h.01"/></svg>
                    </div>
                    <!-- Icono de Usuario (Opcional, puede ser la foto) -->
                    <i class="fas fa-user-circle text-gray-400 text-2xl"></i>
                </div>
            </div>
        </header>

        <!-- Contenedor de Vistas (Scrollable) -->
        <div id="view-container" class="flex-grow overflow-y-auto px-4 pt-4">
            <!-- El contenido de la vista se inyecta aqu√≠ -->
        </div>
        
        <!-- Alerta Inteligente Flotante -->
        <div id="smart-alert" class="fixed top-20 left-1/2 transform -translate-x-1/2 w-11/12 max-w-sm 
                                    text-white p-3 rounded-xl shadow-2xl z-50 transition-opacity duration-500 
                                    opacity-0 pointer-events-none text-sm font-medium text-center">
            <!-- Mensaje de alerta inyectado por JS -->
        </div>

        <!-- Modal de Carga (Oculto por defecto) -->
        <div id="loading-modal" class="fixed inset-0 bg-white bg-opacity-90 hidden items-center justify-center z-50">
            <div class="text-center">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-focus-primary h-12 w-12 mb-4 mx-auto"></div>
                <p class="text-lg font-semibold text-gray-700">Cargando...</p>
            </div>
        </div>
        
        <!-- Navegaci√≥n Inferior (Visible solo despu√©s del login) -->
        <nav id="bottom-nav" class="hidden fixed bottom-0 w-full max-w-sm mx-auto bg-white border-t border-gray-100 p-2 shadow-lg z-20" style="max-width: 420px;">
            <div class="flex justify-around items-center h-14">
                
                <!-- Item 1: Focus (Home/Principal) -->
                <button id="nav-focus" onclick="changeView('focus')" class="nav-item flex flex-col items-center justify-center text-focus-primary text-xs font-medium w-full">
                    <i class="fas fa-bullseye text-xl mb-1"></i>
                    <span>Focus</span>
                </button>
                
                <!-- Item 2: Recompensas -->
                <button id="nav-rewards" onclick="changeView('rewards')" class="nav-item flex flex-col items-center justify-center text-gray-500 text-xs font-medium w-full">
                    <i class="fas fa-medal text-xl mb-1"></i>
                    <span>Recompensas</span>
                </button>
                
                <!-- Item 3: Dashboard (Ranking) -->
                <button id="nav-dashboard" onclick="changeView('dashboard')" class="nav-item flex flex-col items-center justify-center text-gray-500 text-xs font-medium w-full">
                    <i class="fas fa-tachometer-alt text-xl mb-1"></i>
                    <span>Dashboard</span>
                </button>

                <!-- Item 4: Estad√≠stica (NUEVO) -->
                <button id="nav-stats" onclick="changeView('stats')" class="nav-item flex flex-col items-center justify-center text-gray-500 text-xs font-medium w-full">
                    <i class="fas fa-chart-line text-xl mb-1"></i>
                    <span>Estad√≠stica</span>
                </button>
                
                <!-- Item 5: Perfil -->
                <button id="nav-profile" onclick="changeView('profile')" class="nav-item flex flex-col items-center justify-center text-gray-500 text-xs font-medium w-full">
                    <i class="fas fa-user text-xl mb-1"></i>
                    <span>Perfil</span>
                </button>

            </div>
        </nav>
    </div>
<script>
        // --- MOCK DATA and STATE MANAGEMENT ---
        let appState = {
            currentView: 'login',
            isFocusModeActive: false,
            focusTimeSession: 0, // seconds in current session
            focusTimeToday: 5400, // 90 minutes total (mock data)
            dailyFocusPercentage: 65,
            socialMediaMinutes: 12, 
            focusCoins: 1250,
            rankingPosition: 7,
            totalEmployees: 45,
            employeeName: "Eduardo Rojas", 
            employeeLevel: "Guerrero Digital", 
            medals: ['Pomodoro Master', 'Semana Limpia', 'Top 5 Productividad'], 
            
            // Frases Motivadoras (NUEVO)
            motivationalPhrases: [
                "Tu concentraci√≥n es tu mejor activo.",
                "¬°T√∫ puedes recuperar el enfoque!",
                "Respira, reajusta y sigue con todo.",
                "Un paso a la vez. ¬°Sigue as√≠!",
                "La disciplina es el puente entre las metas y los logros."
            ],
            
            // Datos del Ranking Semanal (ACTUALIZADO A TOP 5)
            topRankers: [
                { name: 'Alex Fernandez', time: '41h 15m', position: 1 },
                { name: 'Diana Morales', time: '39h 30m', position: 2 },
                { name: 'Eduardo Rojas', time: '37h 5m', position: 3 },
                { name: 'Lluliza Bacalla', time: '36h 45m', position: 4 },
                { name: 'Sofia Toscano', time: '35h 10m', position: 5 },
            ],
            // Datos del Ranking Mensual (ACTUALIZADO A TOP 5)
            monthlyTopRankers: [
                { name: 'Diana Morales', time: '160h 20m', position: 1 },
                { name: 'Alex Fernandez', time: '158h 10m', position: 2 },
                { name: 'Sofia Toscano', time: '155h 50m', position: 3 },
                { name: 'Eduardo Rojas', time: '152h 30m', position: 4 },
                { name: 'Lluliza Bacalla', time: '149h 40m', position: 5 },
            ],

            // Retos (NUEVO)
            challenges: {
                weekly: [
                    { name: 'Semana sin Distracciones', goal: 'Mantener <1h de redes', progress: '35 min', status: 'En Progreso', color: 'bg-yellow-100 text-yellow-700' },
                    { name: '5 D√≠as Focus', goal: '5 sesiones de 90 min', progress: '3/5', status: 'En Progreso', color: 'bg-yellow-100 text-yellow-700' },
                ],
                monthly: [
                    { name: 'Marat√≥n de Concentraci√≥n', goal: '120 Horas Focus', progress: '85h', status: 'En Progreso', color: 'bg-yellow-100 text-yellow-700' },
                    { name: 'Top 10 Mensual', goal: 'Ser Top 10 en ranking', progress: 'Posici√≥n 7', status: 'Completado', color: 'bg-green-100 text-green-700' },
                ]
            },
            
            // Uso de Redes Sociales por d√≠a de la semana (Mock para Perfil) (NUEVO)
            weeklySocialUsage: [
                { day: 'Lun', minutes: 20 },
                { day: 'Mar', minutes: 10 },
                { day: 'Mi√©', minutes: 45 },
                { day: 'Jue', minutes: 30 },
                { day: 'Vie', minutes: 15 }
            ],

            // Estado del filtro de desglose de distracciones (NUEVO)
            distractionFilter: 'week', // 'day', 'week', 'month'

            // Distracciones por App (Mock para Perfil)
            appDistractions: {
                day: [
                    { name: 'Instagram', minutes: 15, icon: 'fab fa-instagram', color: 'bg-pink-500' },
                    { name: 'TikTok', minutes: 5, icon: 'fab fa-tiktok', color: 'bg-black' },
                ],
                week: [
                    { name: 'Instagram', minutes: 60, icon: 'fab fa-instagram', color: 'bg-pink-500' },
                    { name: 'TikTok', minutes: 45, icon: 'fab fa-tiktok', color: 'bg-black' },
                    { name: 'X (Twitter)', minutes: 30, icon: 'fab fa-twitter', color: 'bg-blue-400' },
                    { name: 'YouTube', minutes: 15, icon: 'fab fa-youtube', color: 'bg-red-600' },
                ],
                month: [
                    { name: 'Instagram', minutes: 240, icon: 'fab fa-instagram', color: 'bg-pink-500' },
                    { name: 'TikTok', minutes: 180, icon: 'fab fa-tiktok', color: 'bg-black' },
                    { name: 'X (Twitter)', minutes: 120, icon: 'fab fa-twitter', color: 'bg-blue-400' },
                    { name: 'YouTube', minutes: 60, icon: 'fab fa-youtube', color: 'bg-red-600' },
                    { name: 'Netflix', minutes: 45, icon: 'fas fa-tv', color: 'bg-red-700' },
                ]
            },

            // Recompensas canjeables por puntos
            rewards: [
                { id: 1, name: 'Tarde Libre (4h)', cost: 5000, description: 'Disfruta de 4 horas libres un viernes por la tarde.' },
                { id: 2, name: 'Vale de Caf√© Premium', cost: 800, description: 'Canjea por tu bebida favorita en la cafeter√≠a.' },
                { id: 3, name: 'Suscripci√≥n a Cursos (1 mes)', cost: 10000, description: 'Acceso a plataformas de aprendizaje por un mes.' },
            ],

            // NUEVO: Premios por rendimiento (no canjeables)
            performancePrizes: [
                { id: 100, name: 'Curso a Libre Elecci√≥n (Valor S/ 1000)', description: 'Premio especial al TOP 1 por 3 meses consecutivos.' }
            ],

            // Lista de Apps a Monitorear (Actualizada con Instagram y TikTok)
            monitoredApps: [
                { name: 'WhatsApp', isMonitored: true, icon: 'fab fa-whatsapp', color: 'text-green-500' },
                { name: 'Netflix', isMonitored: false, icon: 'fas fa-tv', color: 'text-red-700' },
                { name: 'Spotify', isMonitored: true, icon: 'fab fa-spotify', color: 'text-green-600' },
                { name: 'Telegram', isMonitored: false, icon: 'fab fa-telegram', color: 'text-blue-500' },
                { name: 'Instagram', isMonitored: true, icon: 'fab fa-instagram', color: 'text-pink-500' },
                { name: 'TikTok', isMonitored: false, icon: 'fab fa-tiktok', color: 'text-black' },
            ],
            
            alertsSent: 0,
            timerInterval: null,
            autoFocusInterval: null, // Para el scheduler de horario laboral
            isAutoWorkModeEnabled: true // Toggle para el modo auto
        };

        const viewContainer = document.getElementById('view-container');
        const coinBalanceEl = document.getElementById('coin-balance');
        const smartAlertEl = document.getElementById('smart-alert');
        const appEl = document.getElementById('app');
        const bottomNavEl = document.getElementById('bottom-nav');
        const mainHeaderEl = document.getElementById('main-header');
        const loadingModalEl = document.getElementById('loading-modal');


        // --- UTILITY FUNCTIONS ---
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        function updateCoinBalance() {
            coinBalanceEl.textContent = appState.focusCoins.toLocaleString('es-ES');
        }

        function showAlert(message, isError = true) {
            const alertEl = document.getElementById('smart-alert');
            alertEl.innerHTML = message;
            
            alertEl.classList.remove('bg-red-600', 'bg-green-600', 'bg-distraction');
            // Usamos la variable 'distraction' para el error, y verde para el √©xito
            alertEl.classList.add(isError ? 'bg-distraction' : 'bg-green-600');

            alertEl.classList.remove('opacity-0', 'pointer-events-none');
            alertEl.classList.add('opacity-100');
            
            setTimeout(() => {
                alertEl.classList.remove('opacity-100');
                alertEl.classList.add('opacity-0', 'pointer-events-none');
            }, 5000);
        }

        function showLoadingModal() {
            loadingModalEl.classList.add('flex');
            loadingModalEl.classList.remove('hidden');
        }

        function hideLoadingModal() {
            loadingModalEl.classList.remove('flex');
            loadingModalEl.classList.add('hidden');
        }

        /**
         * Obtiene la hora actual formateada como HH:MM
         */
        function getCurrentFormattedTime() { 
            const now = new Date();
            // Usar la hora local para la visualizaci√≥n
            const h = now.getHours().toString().padStart(2, '0');
            const m = now.getMinutes().toString().padStart(2, '0');
            return `${h}:${m}`;
        }

        // --- FUNCIONES A√ëADIDAS PARA CORREGIR LOS ERRORES DE VISTA (Estad√≠stica y Perfil) ---

        /**
         * Genera el HTML para el gr√°fico de barras de uso social semanal.
         */
        function drawSocialUsageGraph() {
            const maxMinutes = 50; // Max visual para escala (ej: 50 minutos)
            const barsHtml = appState.weeklySocialUsage.map(data => {
                // Limitar la altura al 100% si los minutos exceden maxMinutes
                const heightPercentage = Math.min(100, (data.minutes / maxMinutes) * 100);
                return `
                    <div class="flex flex-col items-center h-full justify-end px-1">
                        <span class="text-xs font-semibold text-distraction mb-1">${data.minutes}</span>
                        <div class="w-4 bg-distraction rounded-t-sm transition-all duration-500" style="height: ${heightPercentage}%;"></div>
                        <span class="text-xs text-gray-500 mt-1">${data.day}</span>
                    </div>
                `;
            }).join('');

            return `<div class="flex items-end justify-around h-40 w-full p-2 border-l border-b border-gray-200">${barsHtml}</div>`;
        }

        /**
         * Actualiza el filtro de desglose de distracciones y renderiza la vista de estad√≠stica.
         * @param {string} filter - 'day', 'week', o 'month'
         */
        function setDistractionFilter(filter) {
            appState.distractionFilter = filter;
            renderStatsView();
        }

        /**
         * Genera el HTML para la lista de retos (usado en la vista de Perfil).
/**
         * Genera el HTML para la lista de retos (usado en la vista de Perfil).
         * CORRECCI√ìN #3: Dise√±o m√°s amigable y visual.
         * @param {Array} challenges - Lista de retos.
         */
        function renderChallenges(challenges) {
            return challenges.map(challenge => {
                // Determinar color de borde, iconos y progreso
                const isCompleted = challenge.status === 'Completado';
                const borderColor = isCompleted ? 'border-focus-primary' : 'border-focus-secondary';
                const icon = isCompleted ? '‚úÖ' : '‚è≥';
                const statusColor = isCompleted ? 'text-focus-primary' : 'text-focus-secondary';
                
                return `
                    <div class="flex items-center justify-between p-4 bg-white rounded-xl shadow-md border-l-4 ${borderColor} transition duration-300 hover:shadow-lg">
                        <div class="flex items-center space-x-3">
                            <div class="text-2xl">${icon}</div>
                            <div>
                                <p class="font-bold text-gray-800">${challenge.name}</p>
                                <p class="text-xs text-gray-500">Meta: ${challenge.goal}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-sm font-medium ${statusColor}">${challenge.status}</span>
                            <p class="text-xl font-extrabold text-gray-700">${challenge.progress}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- CORE LOGIC (Timer / Focus Mode) ---
        function startFocusTimer() {
            if (appState.timerInterval) return;

            appState.timerInterval = setInterval(() => {
                appState.focusTimeSession++;
                appState.focusTimeToday++;
                
                // Simulaci√≥n de uso de redes que baja si se est√° enfocando
                appState.socialMediaMinutes = Math.max(0, appState.socialMediaMinutes - 1); 
                
                // Gana FocusCoins cada 5 minutos (300 segundos)
                if (appState.focusTimeSession % 300 === 0) {
                    appState.focusCoins += 50;
                    updateCoinBalance();
                    showAlert('üí∞ ¬°50 FocusCoins ganados por 5 minutos de enfoque!', false);
                }

                // Alerta Inteligente: Simulaci√≥n de detecci√≥n de uso excesivo de redes
                if (appState.focusTimeSession > 10 && appState.focusTimeSession % 60 === 0 && appState.alertsSent < 3) {
                    if (Math.random() < 0.2) { // 20% de probabilidad cada minuto
                        appState.socialMediaMinutes = 12; // Excede el l√≠mite de 10
                        showAlert('üö® Alerta: ¬°Has superado tu l√≠mite de 10 minutos en redes! Vuelve al enfoque.', true);
                        appState.alertsSent++;
                    }
                }

                // Si estamos en la vista de enfoque, actualiza el UI
                if (appState.currentView === 'focus') {
                    renderFocusView();
                }

            }, 1000);
        }

        function stopFocusTimer() {
            clearInterval(appState.timerInterval);
            appState.timerInterval = null;
            appState.alertsSent = 0; // Reset alerts
            appState.focusTimeSession = 0; // Reset session time
        }



        function toggleFocusMode() {
            appState.isFocusModeActive = !appState.isFocusModeActive;

            if (appState.isFocusModeActive) {
                startFocusTimer();
                appEl.classList.add('focus-active');
            } else {
                stopFocusTimer();
                appEl.classList.remove('focus-active');
            }
            renderFocusView();
        }

                // ‚úÖ NUEVA FUNCI√ìN: Intento de detener el enfoque durante el bloqueo autom√°tico
        function attemptStopFocus() {
            const isWorkTime = checkWorkHours();
            const currentTime = getCurrentFormattedTime();

            if (isWorkTime && appState.isAutoWorkModeEnabled) {
                // Si es horario laboral y el modo auto est√° activado, mostrar la alerta de bloqueo
                showAlert(`üö´ Son las ${currentTime}, te encuentras dentro de tu horario laboral. El Modo Enfoque est√° bloqueado.`, true);
            } else {
                // Si no est√° bloqueado (porque el modo auto est√° desactivado o no es hora), permitir la detenci√≥n manual
                toggleFocusMode();
            }
        }

        /**
         * Funci√≥n principal de inicio de sesi√≥n.
         * @param {string} provider - 'email', 'google', o 'microsoft'
         */
        function handleLogin(provider = 'email') {
            // Si es Google o Microsoft, primero va a la pantalla de validaci√≥n
            if (provider === 'google') {
                changeView('googleValidation');
            } else if (provider === 'microsoft') {
                changeView('microsoftValidation');
            } else {
                // CORRECCI√ìN: Para 'email', debe llamar a startAppLoad() para iniciar
                // el delay y la transici√≥n a la vista de detecci√≥n de apps.
                startAppLoad(); 
            }
        }

        /**
         * FUNCI√ìN: Inicia el proceso de carga gen√©rico
         */
        function startAppLoad() {
            // Simulaci√≥n de inicio de sesi√≥n exitoso
            changeView('startingSession'); 

            setTimeout(() => {
                // Ir a la detecci√≥n de apps
                changeView('appDetection'); 
            }, 1500); // Peque√±o delay de 1.5 segundos para la vista de "Iniciando Sesi√≥n"
        }


        /**
         * FUNCI√ìN: Cierra la sesi√≥n, limpia el estado y vuelve al login.
         */
        function handleLogout() {
            // Detener temporizadores activos
            if (appState.timerInterval) {
                stopFocusTimer();
            }
            if (appState.autoFocusInterval) {
                clearInterval(appState.autoFocusInterval);
                appState.autoFocusInterval = null;
            }

            // Resetear estado principal (no es necesario resetear monedas o historial)
            appState.isFocusModeActive = false;
            appState.focusTimeSession = 0;
            appState.alertsSent = 0;
            
            // Remover filtro visual
            appEl.classList.remove('focus-active');
            
            // Navegar a la vista de login
            changeView('login');
            showAlert('Sesi√≥n cerrada con √©xito.', false);
        }

        function toggleMonitoredApp(index) {
            appState.monitoredApps[index].isMonitored = !appState.monitoredApps[index].isMonitored;
            // No re-renderizar, el cambio en el input ya lo maneja
        }

function confirmAppDetection() {
            // Mostrar modal de cargando
            showLoadingModal();
            
            // Simular tiempo de carga y luego ir al dashboard
            setTimeout(() => {
                hideLoadingModal(); // Ocultar modal
                bottomNavEl.classList.remove('hidden');
                mainHeaderEl.classList.remove('hidden');

                // --- NUEVO: Iniciar el programador de horario laboral ---
                if (!appState.autoFocusInterval) {
                    // Inicia el intervalo para revisar cada 60 segundos
                    appState.autoFocusInterval = setInterval(manageAutoFocus, 60000); 
                }
                // Forzar una revisi√≥n inmediata al iniciar sesi√≥n
                manageAutoFocus();
                
                // ‚úÖ MODIFICACI√ìN (Petici√≥n Anterior): Iniciar el modo enfoque y el temporizador autom√°ticamente
                if (!appState.isFocusModeActive) {
                    toggleFocusMode(); 
                    showAlert('Modo Enfoque iniciado autom√°ticamente.', false);
                }
                
                // --- CAMBIO: Primera vista es 'focus' ---
                changeView('focus'); // Ir al Dashboard (panel)
            }, 2000); 
        }
        // --- NUEVAS FUNCIONES PARA HORARIO LABORAL ---

        function toggleAutoWorkMode() {
            appState.isAutoWorkModeEnabled = !appState.isAutoWorkModeEnabled;
            renderFocusView(); // Re-renderizar la vista de enfoque para actualizar el toggle
            
            if (!appState.isAutoWorkModeEnabled && appState.isFocusModeActive) {
                // Si el usuario desactiva el modo auto y el foco est√° activo,
                // le damos control manual (no detenemos el foco, solo el auto-control)
                console.log("Modo Auto-Enfoque Desactivado. Control manual.");
            } else if (appState.isAutoWorkModeEnabled) {
                // Si lo activa, forzamos una revisi√≥n inmediata
                manageAutoFocus();
            }
        }

function checkWorkHours() {
            // ‚ö†Ô∏è MODIFICACI√ìN TEMPORAL: Fuerza el estado a "Horario Laboral" para la prueba
            if (appState.isAutoWorkModeEnabled) {
                return true; 
            }
            
            // L√≥gica original (Ignorada temporalmente)
            const now = new Date();
            const day = now.getDay(); // 0 = Domingo, 6 = S√°bado
            const hour = now.getHours(); // 0-23

            if (day === 0 || day === 6) {
                return false;
            }

            const isMorningSession = hour >= 8 && hour < 13;
            const isAfternoonSession = hour >= 14 && hour < 17;

            return isMorningSession || isAfternoonSession;
        }

        function manageAutoFocus() {
            // Solo se ejecuta si el usuario tiene el modo autom√°tico activado
            if (!appState.isAutoWorkModeEnabled) {
                return;
            }

            const isWorkTime = checkWorkHours();

            if (isWorkTime && !appState.isFocusModeActive) {
                // Es hora de trabajar y el foco no est√° activo -> INICIAR
                console.log("Auto-Focus: Iniciando sesi√≥n por horario laboral.");
                toggleFocusMode(); // Esto inicia el timer y actualiza la UI
                
                // Se elimina el 'showAlert' de aqu√≠. El mensaje grande se
                // renderizar√° directamente en la vista de 'focus'.
            } else if (!isWorkTime && appState.isFocusModeActive) {
                // No es hora de trabajar (descanso o fuera de horario) y el foco S√ç est√° activo -> DETENER
                console.log("Auto-Focus: Deteniendo sesi√≥n por descanso/fuera de horario.");
                toggleFocusMode(); // Esto detiene el timer y actualiza la UI
                
                // CAMBIO MANTENIDO
                if (appState.currentView === 'focus') {
                    showAlert('Modo Enfoque detenido por horario de descanso.', false);
                }
            }
        }

        // --- VIEW RENDERING FUNCTIONS ---

        function renderLoginView() {
            viewContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center h-screen-minus-nav text-center p-6 -mt-10">
                    
                    <h1 class="text-6xl font-extrabold text-focus-primary">Focus<span class="text-focus-secondary">+</span></h1>
                    <p class="mt-2 text-base font-medium text-gray-700 max-w-xs leading-snug">
                        Menos distracciones, m√°s enfoque, m√°s recompensas.
                    </p>
                    
                    <div class="mt-8 w-full px-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Iniciar Sesi√≥n Corporativa</h2>

                        <form onsubmit="event.preventDefault(); handleLogin('email');" class="space-y-4">
                            <div>
                                <label for="username" class="sr-only">Usuario/Email</label>
                                <div class="relative">
                                    <input type="text" id="username" name="username" required placeholder="Usuario o Email Corporativo"
                                        class="w-full py-3 pl-12 pr-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-focus-primary focus:border-focus-primary transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                </div>
                            </div>

                            <div>
                                <label for="password" class="sr-only">Contrase√±a</label>
                                <div class="relative">
                                    <input type="password" id="password" name="password" required placeholder="Contrase√±a"
                                        class="w-full py-3 pl-12 pr-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-focus-primary focus:border-focus-primary transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"><rect x="3" y="11" width="18" height="10" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                                </div>
                            </div>

                            <button type="submit" class="w-full bg-focus-primary text-white font-bold py-3 rounded-xl transition duration-200 shadow-lg hover:bg-teal-700">
                                Acceder
                            </button>
                        </form>
                        
                        <div class="flex items-center my-6">
                            <hr class="flex-grow border-gray-300">
                            <span class="px-3 text-sm text-gray-500 font-medium">o continuar con</span>
                            <hr class="flex-grow border-gray-300">
                        </div>

                        <div class="space-y-3">
                            <button onclick="handleLogin('microsoft')" class="w-full flex items-center justify-center space-x-3 bg-white border border-gray-300 text-gray-700 font-semibold py-3 rounded-xl transition duration-200 hover:bg-gray-50 shadow-sm">
                                <i class="fab fa-microsoft text-blue-500 text-xl"></i>
                                <span>Microsoft</span>
                            </button>
                            <button onclick="handleLogin('google')" class="w-full flex items-center justify-center space-x-3 bg-white border border-gray-300 text-gray-700 font-semibold py-3 rounded-xl transition duration-200 hover:bg-gray-50 shadow-sm">
                                <i class="fab fa-google text-red-500 text-xl"></i>
                                <span>Google</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- VISTA: Validaci√≥n de Google ---
        function renderGoogleValidationView() {
            viewContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center h-screen-minus-nav text-center p-6 -mt-10">
                    <i class="fab fa-google text-red-500 text-8xl mb-6"></i>
                    <h2 class="text-3xl font-extrabold text-gray-800 mb-3">Validaci√≥n de Google Workspace</h2>
                    <p class="text-gray-600 mb-8 max-w-xs">
                        Por favor, verifica tu identidad y otorga acceso a Focus+ para medir tu productividad.
                    </p>
                    
                    <button onclick="startAppLoad()" class="w-full max-w-xs bg-focus-primary text-white font-bold py-3 rounded-xl transition duration-200 shadow-lg hover:bg-teal-700">
                        Continuar con tu Cuenta Google
                    </button>
                    <button onclick="changeView('login')" class="w-full max-w-xs mt-3 text-sm text-gray-500 font-medium py-3 rounded-xl hover:text-focus-primary transition">
                        Cancelar y volver al Login
                    </button>
                </div>
            `;
        }

        // --- VISTA: Validaci√≥n de Microsoft ---
        function renderMicrosoftValidationView() {
            viewContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center h-screen-minus-nav text-center p-6 -mt-10">
                    <i class="fab fa-microsoft text-blue-500 text-8xl mb-6"></i>
                    <h2 class="text-3xl font-extrabold text-gray-800 mb-3">Validaci√≥n de Microsoft 365</h2>
                    <p class="text-gray-600 mb-8 max-w-xs">
                        Por favor, inicia sesi√≥n con tu cuenta corporativa para sincronizar con Focus+.
                    </p>
                    
                    <button onclick="startAppLoad()" class="w-full max-w-xs bg-focus-primary text-white font-bold py-3 rounded-xl transition duration-200 shadow-lg hover:bg-teal-700">
                        Continuar con tu Cuenta Microsoft
                    </button>
                    <button onclick="changeView('login')" class="w-full max-w-xs mt-3 text-sm text-gray-500 font-medium py-3 rounded-xl hover:text-focus-primary transition">
                        Cancelar y volver al Login
                    </button>
                </div>
            `;
        }

        // --- VISTA: Iniciando Sesi√≥n (Carga) ---
        function renderStartingSessionView() {
            viewContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center h-screen-minus-nav text-center p-6">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-focus-primary h-16 w-16 mb-6 mx-auto"></div>
                    <h2 class="text-3xl font-extrabold text-focus-primary mb-2">Iniciando Sesi√≥n...</h2>
                    <p class="text-gray-500 text-base mt-2 max-w-xs">
                        Preparando tu perfil de productividad.
                    </p>
                </div>
            `;
        }


        function renderAppDetectionView() {
            const appsListHtml = appState.monitoredApps.map((app, index) => `
                <li class="flex items-center justify-between p-4 bg-white rounded-xl shadow-sm border border-gray-100">
                    <div class="flex items-center">
                        <div class="w-8 h-8 text-xl flex items-center justify-center rounded-full mr-4">
                            <i class="${app.icon} ${app.color}"></i>
                        </div>
                        <div>
                            <span class="font-bold text-gray-800">${app.name}</span>
                            <p class="text-xs text-gray-500">${app.isMonitored ? 'Monitoreo: Activo' : 'Monitoreo: Desactivado'}</p>
                        </div>
                    </div>
                    
                    <label class="relative inline-block w-12 h-6">
                        <input type="checkbox" class="toggle-checkbox" 
                                id="toggle-${index}"
                                ${app.isMonitored ? 'checked' : ''} onchange="toggleMonitoredApp(${index})">
                        <span class="toggle-label"></span>
                    </label>
                </li>
            `).join('');

            viewContainer.innerHTML = `
                <div class="h-full flex flex-col pt-4">
                    <h2 class="text-3xl font-extrabold text-gray-800 mb-2">Detecci√≥n de Aplicaciones</h2>
                    <p class="text-sm text-gray-500 mb-6">Selecciona las aplicaciones que deseas monitorear para medir tu enfoque y evitar distracciones.</p>

                    <div class="space-y-3 flex-grow overflow-y-auto pb-4">
                        <ul class="space-y-3">
                            ${appsListHtml}
                        </ul>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-100 sticky bottom-0 bg-white">
                        <button onclick="confirmAppDetection()" class="w-full bg-focus-primary text-white font-bold py-3 rounded-xl transition duration-200 shadow-lg hover:bg-teal-700">
                            Confirmar y Empezar
                        </button>
                    </div>
                </div>
            `;
        }


function renderFocusView() {
            // --- NUEVA L√ìGICA DE BLOQUEO ---
            const isWorkTime = checkWorkHours();
            const isManualStopBlocked = appState.isFocusModeActive && appState.isAutoWorkModeEnabled && isWorkTime;

            const timerDisplay = formatTime(appState.focusTimeSession);
            const statusColor = appState.isFocusModeActive ? 'bg-green-100 text-green-700 border-green-500' : 'bg-yellow-100 text-yellow-700 border-yellow-500';
            const statusText = appState.isFocusModeActive ? 'MODO ENFOQUE ACTIVO' : 'MODO ENFOQUE DESACTIVADO';
            
            // L√≥gica del bot√≥n
            const buttonText = appState.isFocusModeActive ? 'DETENER SESI√ìN' : 'INICIAR ENFOQUE';
            const buttonClass = appState.isFocusModeActive ? 'bg-distraction hover:bg-rose-700' : 'bg-focus-primary hover:bg-teal-800';
            const buttonHandler = isManualStopBlocked ? 'attemptStopFocus()' : 'toggleFocusMode()';
            const disabledAttribute = isManualStopBlocked ? 'disabled' : '';
            const disabledClass = isManualStopBlocked ? 'opacity-50 cursor-not-allowed hover:bg-distraction' : ''; // Mantener el color de fondo para la consistencia visual, pero con menor opacidad
            // --- FIN NUEVA L√ìGICA DE BLOQUEO ---

            const alertText = appState.socialMediaMinutes > 10 ? 
                '<span class="text-distraction font-semibold">ALERTA: Redes sociales en uso (Bloqueado)</span>' : 
                '<span class="text-green-600 font-semibold">Monitoreo: Uso dentro del l√≠mite</span>';

            // --- Mensaje grande de Auto-Enfoque ---
            let autoModeMessage = '';
            // Mostrar este bloque si el foco est√° activo Y el modo auto est√° habilitado Y estamos en horario laboral
            if (appState.isFocusModeActive && appState.isAutoWorkModeEnabled && checkWorkHours()) {
                const currentTime = getCurrentFormattedTime();
                autoModeMessage = `
                    <div class="p-6 bg-focus-primary text-white rounded-2xl text-center font-extrabold mb-6 shadow-xl">
                        <i class="fas fa-business-time text-2xl mb-3"></i>
                        <p class="uppercase text-3xl mb-1">SON LAS 8:30 am</p>
                        <p class="uppercase text-xl">SE HA ACTIVADO EN AUTOM√ÅTICO EL MODO ENFOQUE</p>
                    </div>`;
            }

            viewContainer.innerHTML = `
                <h2 class="text-xl font-semibold mb-6 text-gray-800">Modo Enfoque Inteligente</h2> 
                
                ${autoModeMessage}

                <div class="bg-focus-primary p-6 rounded-2xl shadow-lg mb-6 text-white text-center">
                    <p class="text-sm font-medium mb-2 opacity-80">Tiempo de Sesi√≥n</p>
                    <div id="session-timer" class="text-5xl font-extrabold tracking-tight">${timerDisplay}</div>
                </div>

                <button onclick="${buttonHandler}" ${disabledAttribute} class="w-full ${buttonClass} ${disabledClass} text-white font-bold py-3 rounded-xl transition duration-200 shadow-md mb-6 flex items-center justify-center space-x-2">
                    ${appState.isFocusModeActive ? 
                        `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>` : 
                        `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>`
                    }
                    <span>${buttonText}</span>
                </button>

                <div class="space-y-4 mb-6"> 
                    <div class="p-4 border-l-4 ${statusColor} rounded-xl text-center font-semibold text-sm">
                        ${statusText}
                    </div>

                    <div class="flex items-center justify-between p-4 bg-white rounded-xl shadow-sm border border-gray-100">
                        <div>
                            <h3 class="font-semibold text-gray-700">Auto-Enfoque Laboral</h3>
                            <p class="text-xs text-gray-500">Activar/Detener foco (Lun-Vie, 8-1 y 2-5)</p>
                        </div>
                        <label class="relative inline-block w-12 h-6">
                            <input type="checkbox" class="toggle-checkbox" 
                                    id="toggle-auto-focus"
                                    ${appState.isAutoWorkModeEnabled ? 'checked' : ''} onchange="toggleAutoWorkMode()">
                            <span class="toggle-label"></span>
                        </label>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="font-semibold text-gray-700 flex items-center mb-2">
                            <i class="fas fa-eye text-focus-primary mr-2"></i>
                            Monitoreo de Apps
                        </h3>
                        <p class="text-sm text-gray-600">Alerta inteligente cuando se detecta uso fuera de las apps permitidas.</p>
                        <div class="mt-3 p-2 bg-gray-50 rounded-lg text-xs font-medium text-center">
                            ${alertText}
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-2xl shadow-lg mt-6 mb-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Horario de Enfoque Programado</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-3 rounded-xl bg-red-100 border border-red-300">
                            <span class="font-medium text-red-700">8:00 AM - 12:00 PM</span>
                            <span class="text-sm font-semibold text-red-800 flex items-center">
                                <i class="fas fa-lock mr-2"></i> Modo enfoque
                            </span>
                        </div>
                        <div class="flex justify-between items-center p-3 rounded-xl bg-green-100 border border-green-300">
                            <span class="font-medium text-green-700">12:00 PM - 1:00 PM</span>
                            <span class="text-sm font-semibold text-green-800 flex items-center">
                                <i class="fas fa-mug-hot mr-2"></i> Refrigerio (Libre)
                            </span>
                        </div>
                        <div class="flex justify-between items-center p-3 rounded-xl bg-red-100 border border-red-300">
                            <span class="font-medium text-red-700">1:00 PM - 5:00 PM</span>
                            <span class="text-sm font-semibold text-red-800 flex items-center">
                                <i class="fas fa-lock mr-2"></i> Modo enfoque
                            </span>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-3 text-center">Modo enfoque se aplica autom√°ticamente en los horarios en rojo.</p>
                </div>
            `;
        }
        function renderRewardsView() {
            const rewardsList = appState.rewards.map(reward => `
                <div class="flex justify-between items-center p-4 bg-white rounded-xl shadow-sm border border-gray-100">
                    <div>
                        <h3 class="font-bold text-gray-800">${reward.name}</h3>
                        <p class="text-xs text-gray-500">${reward.description}</p>
                    </div>
                    <div class="flex flex-col items-end">
                        <div class="flex items-center text-lg font-bold text-focus-secondary">
                            ${reward.cost.toLocaleString('es-ES')} 
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-1"><circle cx="12" cy="12" r="10"/><path d="M16 8v8M8 8v8M12 16v-4M12 8v-4M12 12h.01"/></svg>
                        </div>
                        <button onclick="redeemReward(${reward.id})" ${appState.focusCoins < reward.cost ? 'disabled' : ''} class="mt-2 text-xs font-semibold py-1 px-3 rounded-lg transition duration-200 
                            ${appState.focusCoins < reward.cost ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-green-500 text-white hover:bg-green-600'}">
                            Canjear
                        </button>
                    </div>
                </div>
            `).join('');

            viewContainer.innerHTML = `
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Sistema de Recompensas (FocusCoins)</h2>
                
                <div class="flex justify-between items-center bg-focus-primary p-5 rounded-2xl shadow-lg mb-6 text-white">
                    <div>
                        <p class="text-sm font-light">Tu Balance de Puntos</p>
                        <div class="text-4xl font-extrabold tracking-tight flex items-center mt-1">
                            ${appState.focusCoins.toLocaleString('es-ES')}
                            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-2 text-white"><circle cx="12" cy="12" r="10"/><path d="M16 8v8M8 8v8M12 16v-4M12 8v-4M12 12h.01"/></svg>
                        </div>
                    </div>
                    <p class="text-xs font-medium text-white text-right">Gana 50 FocusCoins cada 5 minutos de enfoque.</p>
                </div>

                <h3 class="text-lg font-semibold mb-3 text-gray-700">Cat√°logo Corporativo (Vales, Bonos, D√≠as Libres)</h3>
                
                <div class="space-y-3">
                    ${rewardsList}
                </div>

                <div class="mt-8">
                    <h3 class="text-lg font-semibold mb-3 text-gray-700">Premios de Rendimiento</h3>
                    <div class="space-y-3">
                        ${appState.performancePrizes.map(prize => `
                            <div class="flex justify-between items-center p-4 bg-white rounded-xl shadow-sm border-l-4 border-focus-secondary">
                                <div>
                                    <h3 class="font-bold text-gray-800">${prize.name}</h3>
                                    <p class="text-xs text-gray-500">${prize.description}</p>
                                </div>
                                <div class="text-center px-2">
                                    <span class="text-2xl">üèÜ</span>
                                    <p class="text-xs font-semibold text-focus-secondary">PREMIO</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function redeemReward(rewardId) {
            const reward = appState.rewards.find(r => r.id === rewardId);
            if (!reward) return;

            if (appState.focusCoins >= reward.cost) {
                appState.focusCoins -= reward.cost;
                updateCoinBalance();
                showAlert(`‚úÖ ¬°Canje exitoso! Has obtenido: ${reward.name}.`, false); 
            } else {
                showAlert('üö´ No tienes suficientes FocusCoins para canjear esta recompensa.', true);
            }
            renderRewardsView(); 
        }

        function renderRankingList(rankers, id) {
            return `
                <ul class="divide-y divide-gray-100 mt-2" id="${id}">
                    ${rankers.map(ranker => `
                        <li class="flex justify-between items-center py-2">
                            <div class="flex items-center">
                                <span class="w-6 font-bold text-center text-lg ${ranker.position <= 3 ? 'text-focus-primary' : 'text-gray-500'}">${ranker.position}</span>
                                <span class="ml-3 text-gray-700 font-medium">${ranker.name}</span>
                                ${ranker.name === appState.employeeName ? '<span class="ml-2 text-xs font-semibold text-green-500">(T√∫)</span>' : ''}
                            </div>
                            <span class="text-sm font-bold text-green-600">${ranker.time}</span>
                        </li>
                    `).join('')}
                </ul>
            `;
        }


        function renderDashboardView() {
            const totalHours = (appState.focusTimeToday / 3600).toFixed(1);
            const goalProgress = Math.min(100, (appState.focusTimeToday / (30 * 3600)) * 100).toFixed(0); 
            const rankEmoji = appState.rankingPosition <= 3 ? 'ü•á' : '‚ú®';
            const rankingStatus = appState.rankingPosition <= 5 ? '¬°Excelente rendimiento!' : 'Sigue esforz√°ndote para subir.';
            
            // Gr√°fico Circular (Pie Chart Mockup con SVG)
            const focusPercent = appState.dailyFocusPercentage;
            const focusTimeArc = (focusPercent / 100) * 282.7; 

            const pieChart = `
                <div class="relative w-32 h-32 mx-auto mb-4">
                    <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#FEE2E2" stroke-width="10"></circle>
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#10B981" stroke-width="10"
                            stroke-dasharray="${focusTimeArc}, 282.7" 
                            stroke-linecap="round"></circle>
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span class="text-3xl font-extrabold text-focus-primary">${focusPercent}%</span>
                    </div>
                </div>
            `;

            viewContainer.innerHTML = `
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Panel de Productividad Digital</h2>
                
                <p class="text-center italic text-sm text-gray-500 mb-6" id="motivational-quote">
                    "${appState.motivationalPhrases[Math.floor(Math.random() * appState.motivationalPhrases.length)]}"
                </p>

                <div class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-focus-primary mb-6 text-center">
                    <p class="text-sm font-medium text-gray-500">Porcentaje de Enfoque Diario</p>
                    ${pieChart}
                    
                    <div class="flex justify-around mt-4 border-t pt-4">
                        <div class="text-center">
                            <span class="text-3xl font-bold ${appState.socialMediaMinutes > 10 ? 'text-distraction' : 'text-gray-700'}">${appState.socialMediaMinutes}</span>
                            <p class="text-xs text-gray-500">Min. en Distracci√≥n</p>
                        </div>
                        <div class="text-center">
                            <span class="text-3xl font-bold text-focus-primary">${totalHours}</span>
                            <p class="text-xs text-gray-500">Horas Focus</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6">
                    <h3 class="font-semibold text-lg text-gray-700 flex items-center mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-focus-secondary"><path d="M12 20h0v-2l-1-1v-5a4 4 0 0 1 4-4h2a4 4 0 0 1 4 4v5l-1 1v2h0M12 4v0"/></svg>
                        Mi Posici√≥n
                    </h3>
                    <div class="flex justify-between items-center mt-3 p-3 bg-gray-50 rounded-lg">
                        <span class="text-3xl">${rankEmoji}</span>
                        <span class="text-lg font-bold text-gray-800">Posici√≥n: ${appState.rankingPosition} / ${appState.totalEmployees}</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-2 text-center">${rankingStatus}</p>

                    <div class="space-y-4 mt-6">
                        
                        <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <h4 class="font-bold text-base text-gray-700 mb-1 flex items-center">
                                <i class="fas fa-calendar-week text-focus-secondary mr-2 text-sm"></i>
                                Ranking Semanal
                            </h4>
                            ${renderRankingList(appState.topRankers, 'ranking-list-semanal')}
                        </div>

                        <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <h4 class="font-bold text-base text-gray-700 mb-1 flex items-center">
                                <i class="fas fa-calendar-alt text-focus-secondary mr-2 text-sm"></i>
                                Ranking Mensual
                            </h4>
                            ${renderRankingList(appState.monthlyTopRankers, 'ranking-list-mensual')}
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 border-l-4 border-green-500">
                    <h3 class="font-semibold text-lg text-gray-700 flex items-center mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-green-500"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                        Reto Corporativo
                    </h3>
                    <p class="text-sm font-medium text-gray-600">Reto: "La Semana Productiva"</p>
                    <p class="text-xs text-gray-500 mt-1">Objetivo: 15 horas de enfoque total esta semana.</p>
                    <div class="mt-3 text-center">
                        <span class="inline-block text-base font-bold px-3 py-1 bg-green-100 text-green-700 rounded-full">¬°${goalProgress}% Completado!</span>
                    </div>
                </div>
            `;
        }
        
        // --- MODIFICACIONES EN LAS FUNCIONES DE VISTA ---

        // NUEVA FUNCI√ìN: VISTA DE ESTAD√çSTICA (Contiene los gr√°ficos movidos)
        function renderStatsView() {
            // Desglose de Distracciones por App (Filtrado)
            const appsForFilter = appState.appDistractions[appState.distractionFilter] || [];
            const totalMinutes = appsForFilter.reduce((sum, app) => sum + app.minutes, 0);

            const appDistractionsHtml = appsForFilter.map(app => {
                const percentage = totalMinutes > 0 ? ((app.minutes / totalMinutes) * 100).toFixed(0) : 0;
                return `
                    <div class="flex items-center justify-between py-3 border-b border-gray-100 last:border-b-0">
                        <div class="flex items-center">
                            <div class="w-8 h-8 text-xl flex items-center justify-center rounded-full mr-4 bg-gray-100">
                                <i class="${app.icon} ${app.color}"></i>
                            </div>
                            <span class="font-medium text-gray-700">${app.name}</span>
                        </div>
                        <div class="text-right">
                            <span class="text-lg font-bold text-distraction">${app.minutes} min</span>
                            <p class="text-xs text-gray-500">(${percentage}% del total)</p>
                        </div>
                    </div>
                `;
            }).join('');

            viewContainer.innerHTML = `
                <div class="pt-4">
                    <h2 class="text-3xl font-extrabold text-focus-primary mb-6">Estad√≠stica de Productividad</h2>
                    
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6">
                        <h4 class="font-semibold text-lg text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-chart-bar text-distraction mr-2"></i>
                            Uso de Distracciones Semanal
                        </h4>
                        <p class="text-sm text-gray-500 mb-4">Minutos totales en redes sociales por d√≠a de la semana.</p>
                        ${drawSocialUsageGraph()}
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6">
                        <h4 class="font-semibold text-lg text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-exclamation-triangle text-distraction mr-2"></i>
                            Desglose de Distracciones por App
                        </h4>

                        <div class="flex space-x-2 mb-4">
                            <button onclick="setDistractionFilter('day')" class="distraction-tab ${appState.distractionFilter === 'day' ? 'distraction-tab-active' : 'distraction-tab-inactive'}">D√≠a</button>
                            <button onclick="setDistractionFilter('week')" class="distraction-tab ${appState.distractionFilter === 'week' ? 'distraction-tab-active' : 'distraction-tab-inactive'}">Semana</button>
                            <button onclick="setDistractionFilter('month')" class="distraction-tab ${appState.distractionFilter === 'month' ? 'distraction-tab-active' : 'distraction-tab-inactive'}">Mes</button>
                        </div>

                        <p class="text-xs text-gray-500 mb-3">Total de minutos en distracciones: <span class="font-bold text-gray-700">${totalMinutes} min</span></p>

                        <ul class="divide-y divide-gray-100">
                            ${appDistractionsHtml}
                        </ul>
                    </div>
                    
                </div>
            `;
        }

        function renderProfileView() {
            const medalsHtml = appState.medals.map(medal => `
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-focus-secondary text-white shadow-md">
                    üèÖ ${medal}
                </span>
            `).join('');

            // **NOTA: Las variables appDistractionsHtml y totalMinutes ya NO son necesarias aqu√≠,**
            // **ya que el bloque de desglose fue movido a renderStatsView.**

            viewContainer.innerHTML = `
                <h2 class="text-xl font-semibold mb-6 text-gray-800">Perfil del Empleado</h2>
                
                <div class="bg-focus-primary p-6 rounded-2xl shadow-lg mb-6 text-white text-center">
                    <img src="https://img.icons8.com/emoji/96/smiling-face.png"
                        class="w-16 h-16 rounded-full mx-auto mb-3 border-4 border-white object-cover"
                        alt="">

                    <h3 class="text-2xl font-bold">${appState.employeeName}</h3>
                    <p class="text-sm font-light mt-1">${appState.employeeLevel}</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6">
                    <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-focus-secondary"><path d="M12 15s1.5-1 4-1 4 2 4 2V5l-4-2-4 2-4-2-4 2v7s1.5-1 4-1 4 2 4 2"/></svg>
                        Medallas y Nivel de Enfoque
                    </h4>
                    <div class="flex flex-wrap gap-2 mb-3">
                        ${medalsHtml || '<p class="text-sm text-gray-400">A√∫n no tienes medallas.</p>'}
                    </div>
                    <p class="text-sm text-gray-600 mt-3 font-semibold">Meta de Enfoque Diaria: 80%</p>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6">
                    <h4 class="font-semibold text-lg text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-bullseye text-focus-primary mr-2"></i>
                        Mis Retos de Productividad
                    </h4>
                    <div class="space-y-4">
                        <div>
                            <p class="font-bold text-sm text-gray-800 mb-1">Retos Semanales</p>
                            ${renderChallenges(appState.challenges.weekly)}
                        </div>
                        <div>
                            <p class="font-bold text-sm text-gray-800 mb-1">Retos Mensuales</p>
                            ${renderChallenges(appState.challenges.monthly)}
                        </div>
                    </div>
                </div>
                
                <div class="mt-8 mb-4">
                    <button onclick="handleLogout()" class="w-full bg-distraction text-white font-bold py-3 rounded-xl transition duration-200 shadow-lg hover:bg-rose-700 flex items-center justify-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        <span>Cerrar Sesi√≥n</span>
                    </button>
                </div>
            `;
        }
        // --- NAVIGATION LOGIC ---
        function changeView(viewName) {
            appState.currentView = viewName;
            
            // Renderizar la vista seleccionada
            if (viewName === 'login') {
                renderLoginView();
            } else if (viewName === 'googleValidation') { // NUEVO
                renderGoogleValidationView();
            } else if (viewName === 'microsoftValidation') { // NUEVO
                renderMicrosoftValidationView();
            } else if (viewName === 'startingSession') { // NUEVO
                renderStartingSessionView();
            } else if (viewName === 'appDetection') {
                renderAppDetectionView();
            } else if (viewName === 'focus') {
                renderFocusView();
            } else if (viewName === 'rewards') {
                renderRewardsView();
            } else if (viewName === 'dashboard') {
                renderDashboardView();
            } else if (viewName === 'stats') { // NUEVO: Vista de Estad√≠stica
                renderStatsView();
            } else if (viewName === 'profile') { 
                renderProfileView();
            }

            // Actualizar visibilidad de la navegaci√≥n y el header
            const isMainAppView = ['focus', 'rewards', 'dashboard', 'stats', 'profile'].includes(viewName);

            if (isMainAppView) {
                bottomNavEl.classList.remove('hidden');
                mainHeaderEl.classList.remove('hidden');
                // CAMBIO AQU√ç: Aplicar 'pb-20' al contenedor de la aplicaci√≥n
                appEl.classList.add('pb-20'); 
            } else {
                bottomNavEl.classList.add('hidden');
                mainHeaderEl.classList.add('hidden');
                // CAMBIO AQU√ç: Remover 'pb-20' del contenedor de la aplicaci√≥n
                appEl.classList.remove('pb-20'); 
            }




            // Solo actualizar los iconos si estamos en una vista principal
            if (isMainAppView) {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('text-focus-primary');
                    item.classList.add('text-gray-500');
                });

                const activeNav = document.getElementById(`nav-${viewName}`);
                if (activeNav) {
                    activeNav.classList.remove('text-gray-500');
                    activeNav.classList.add('text-focus-primary');
                }
            }
            
            // Desplazar al inicio del contenido principal
            viewContainer.scrollTop = 0;
        }

        // --- INITIALIZATION ---
        window.onload = function() {
            updateCoinBalance();
            changeView('login'); 
        };
    </script>
    
</body>
</html>